<!DOCTYPE html>
<html lang="id">

<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>UKM Panahan UGM</title>
  <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Source Sans 3', 'Segoe UI', sans-serif;
      background: #f5f3f0;
      display: flex;
      min-height: 100vh;
      color: #2d2d2d;
    }

    /* SIDEBAR */
    .sidebar {
      width: 210px;
      background: #800020;
      height: 100vh;
      position: sticky;
      top: 0;
      display: flex;
      flex-direction: column;
      padding: 0;
      flex-shrink: 0;
    }

    .sidebar-header {
      padding: 22px 18px 18px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.12);
    }

    .sidebar-header h3 {
      color: #fff;
      font-size: 15px;
      font-weight: 700;
    }

    .sidebar-header small {
      color: rgba(255, 255, 255, 0.55);
      font-size: 11px;
    }

    .sidebar nav {
      padding: 10px 8px;
      flex: 1;
    }

    .sidebar nav button {
      display: block;
      width: 100%;
      padding: 9px 14px;
      margin: 1px 0;
      background: none;
      border: none;
      color: rgba(255, 255, 255, 0.72);
      font-size: 13.5px;
      font-family: inherit;
      text-align: left;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.15s, color 0.15s;
    }

    .sidebar nav button:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
    }

    .sidebar nav button.active {
      background: rgba(255, 255, 255, 0.15);
      color: #fff;
      font-weight: 600;
    }

    /* CONTENT */
    .content {
      flex: 1;
      padding: 24px 28px;
      overflow-x: auto;
    }

    .page-title {
      font-size: 20px;
      font-weight: 700;
      color: #2d2d2d;
      margin-bottom: 4px;
    }

    .page-sub {
      font-size: 13px;
      color: #888;
      margin-bottom: 22px;
    }

    /* BANNER */
    .banner {
      background: #800020;
      color: #fff;
      border-radius: 8px;
      padding: 20px 24px;
      margin-bottom: 22px;
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .banner img {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid rgba(255, 255, 255, 0.3);
      flex-shrink: 0;
    }

    .banner h2 {
      font-size: 17px;
      font-weight: 700;
      margin-bottom: 3px;
    }

    .banner p {
      font-size: 13px;
      opacity: 0.8;
      line-height: 1.5;
    }

    /* STAT CARDS */
    .stats {
      display: flex;
      gap: 12px;
      margin-bottom: 22px;
      flex-wrap: wrap;
    }

    .stat {
      flex: 1;
      min-width: 120px;
      background: #fff;
      border: 1px solid #e0ddd9;
      border-radius: 6px;
      padding: 14px 16px;
      border-left: 3px solid #c9a227;
    }

    .stat .num {
      font-size: 22px;
      font-weight: 700;
      color: #800020;
    }

    .stat .label {
      font-size: 11.5px;
      color: #777;
      margin-top: 2px;
    }

    /* TABLE */
    .table-box {
      background: #fff;
      border: 1px solid #e0ddd9;
      border-radius: 6px;
      overflow: hidden;
    }

    .table-top {
      padding: 12px 16px;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .table-top h3 {
      font-size: 14px;
      font-weight: 600;
      color: #2d2d2d;
    }

    .table-top input {
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 5px 10px;
      font-size: 12.5px;
      font-family: inherit;
      outline: none;
      width: 180px;
      color: #333;
    }

    .table-top input:focus {
      border-color: #800020;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      padding: 9px 16px;
      text-align: left;
      font-size: 13px;
      border-bottom: 1px solid #f0eeec;
    }

    th {
      background: #faf8f6;
      color: #555;
      font-weight: 600;
      font-size: 11.5px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    tbody tr:hover {
      background: #fdfcfb;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    td {
      color: #333;
    }

    /* STATES */
    .loading-box {
      padding: 48px;
      text-align: center;
      color: #999;
      font-size: 13px;
    }

    .empty-box {
      padding: 48px 20px;
      text-align: center;
      color: #999;
      font-size: 13px;
    }

    .error-box {
      background: #fef6f0;
      border: 1px solid #f0d6c0;
      border-radius: 6px;
      padding: 14px 18px;
      font-size: 13px;
      color: #7a3b10;
      margin-top: 12px;
      line-height: 1.6;
    }

    .info-text {
      background: #f9f7f4;
      border: 1px solid #e0ddd9;
      border-radius: 6px;
      padding: 16px 20px;
      font-size: 13.5px;
      color: #444;
      line-height: 1.7;
    }

    /* HAMBURGER BUTTON */
    .menu-toggle {
      display: none;
      position: fixed;
      top: 12px;
      left: 12px;
      z-index: 1100;
      background: #800020;
      color: #fff;
      border: none;
      border-radius: 6px;
      width: 40px;
      height: 40px;
      font-size: 22px;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.18);
      transition: background 0.2s;
      line-height: 1;
    }

    .menu-toggle:hover {
      background: #a0002a;
    }

    /* OVERLAY */
    .sidebar-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      z-index: 999;
    }

    .sidebar-overlay.show {
      display: block;
    }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      .menu-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .sidebar {
        position: fixed;
        left: -260px;
        top: 0;
        width: 240px;
        height: 100vh;
        z-index: 1050;
        transition: left 0.3s ease;
        box-shadow: 4px 0 20px rgba(0, 0, 0, 0.2);
      }

      .sidebar.open {
        left: 0;
      }

      body {
        flex-direction: column;
      }

      .content {
        padding: 64px 14px 20px;
        width: 100%;
      }

      .banner {
        flex-direction: column;
        text-align: center;
        padding: 18px 16px;
        gap: 12px;
      }

      .banner img {
        width: 60px;
        height: 60px;
      }

      .stats {
        flex-direction: column;
      }

      .stat {
        min-width: unset;
      }

      .page-title {
        font-size: 18px;
      }

      .table-box {
        overflow-x: auto;
      }

      table {
        min-width: 500px;
      }

      .table-top {
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
      }

      .table-top input {
        width: 100%;
      }

      th,
      td {
        padding: 8px 10px;
        font-size: 12px;
      }
    }

    @media (min-width: 769px) and (max-width: 1024px) {
      .sidebar {
        width: 180px;
      }

      .content {
        padding: 20px 18px;
      }
    }
  </style>
</head>

<body>

  <button class="menu-toggle" id="menuToggle" onclick="toggleSidebar()" aria-label="Menu">☰</button>
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h3>UKM Panahan</h3>
      <small>Universitas Gadjah Mada</small>
    </div>
    <nav>
      <button onclick="loadPage('Home')" class="active" id="btn-Home">Home</button>
      <button onclick="loadPage('UKM PANAHAN')" id="btn-UKM PANAHAN">UKM Panahan</button>
      <button onclick="loadPage('Bacic')" id="btn-Bacic">Basic</button>
      <button onclick="loadPage('Intermediate')" id="btn-Intermediate">Intermediate</button>
      <button onclick="loadPage('Atlet')" id="btn-Atlet">Atlet</button>
      <button onclick="loadPage('Score')" id="btn-Score">Score</button>
      <button onclick="loadPage('Competition')" id="btn-Competition">Competition</button>
    </nav>
  </div>

  <div class="content" id="content">
    <div class="loading-box">Memuat...</div>
  </div>

  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <script>
    const SHEET_ID = '14x5RGGZBdUKPE5WsXkLLPxaAZROOmvRYV48mnYnKRko';
    const SHEETS = ['UKM PANAHAN', 'Bacic', 'Intermediate', 'Atlet', 'Score', 'Competition'];

    // Detect if running inside Google Apps Script
    const isAppsScript = (typeof google !== 'undefined' && google.script && google.script.run);

    function gasRun(fnName, ...args) {
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
        [fnName](...args);
      });
    }

    // ─── Fetch sheet using Google Visualization API (no CORS issues) ───
    function fetchSheetViaGviz(sheetName) {
      return new Promise((resolve, reject) => {
        const query = new google.visualization.Query(
          `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(sheetName)}`
        );
        query.send(response => {
          if (response.isError()) {
            reject(new Error(response.getMessage()));
            return;
          }
          const table = response.getDataTable();
          const rows = [];
          // Headers
          const headers = [];
          for (let c = 0; c < table.getNumberOfColumns(); c++) {
            headers.push(table.getColumnLabel(c));
          }
          rows.push(headers);
          // Data rows
          for (let r = 0; r < table.getNumberOfRows(); r++) {
            const row = [];
            for (let c = 0; c < table.getNumberOfColumns(); c++) {
              const val = table.getFormattedValue(r, c);
              row.push(val || '');
            }
            rows.push(row);
          }
          resolve(rows);
        });
      });
    }

    async function fetchSheet(name) {
      if (isAppsScript) {
        return await gasRun('getSheetData', name);
      }
      return await fetchSheetViaGviz(name);
    }

    async function fetchSummary() {
      if (isAppsScript) {
        return await gasRun('getSummaryData');
      }
      const summary = {};
      await Promise.all(SHEETS.map(async name => {
        try {
          const d = await fetchSheet(name);
          summary[name] = Math.max((d.length || 1) - 1, 0);
        } catch { summary[name] = 0; }
      }));
      return summary;
    }

    function setContent(html) { document.getElementById('content').innerHTML = html; }

    function setActive(name) {
      document.querySelectorAll('.sidebar nav button').forEach(b => b.classList.remove('active'));
      const btn = document.getElementById('btn-' + name);
      if (btn) btn.classList.add('active');
    }

    function filterTable() {
      const q = document.getElementById('q').value.toLowerCase();
      document.querySelectorAll('#tbody tr').forEach(r => {
        r.style.display = r.textContent.toLowerCase().includes(q) ? '' : 'none';
      });
    }

    function renderStats(id, summary) {
      let html = '';
      for (const name in summary) {
        html += `<div class="stat"><div class="num">${summary[name]}</div><div class="label">${name}</div></div>`;
      }
      const el = document.getElementById(id);
      if (el) el.innerHTML = html || '<div class="empty-box">Data kosong.</div>';
    }

    async function showHome() {
      setContent(`
      <div class="banner">
        <img src="https://drive.google.com/thumbnail?id=1xyBUrqgVIvl0DSxzZDmA9K5hDIZTO9qr&sz=w300" alt="Logo">
        <div>
          <h2>UKM Panahan UGM</h2>
          <p>Dashboard data anggota, skor latihan, dan kompetisi.<br>Pilih menu di sebelah kiri untuk membuka data.</p>
        </div>
      </div>
      <h3 class="page-title">Ringkasan</h3>
      <p class="page-sub">Jumlah data per kategori</p>
      <div class="stats" id="summary"><div class="loading-box">Memuat data...</div></div>
    `);
      try {
        renderStats('summary', await fetchSummary());
      } catch (e) {
        document.getElementById('summary').innerHTML =
          `<div class="error-box">Gagal memuat data.<br><small>${e.message}</small></div>`;
      }
    }

    async function showSheet(sheetName) {
      setContent('<div class="loading-box">Memuat ' + sheetName + '...</div>');
      try {
        const data = await fetchSheet(sheetName);
        if (!data || data.length < 2) {
          setContent(`<h3 class="page-title">${sheetName}</h3><p class="page-sub">Tidak ada data.</p><div class="empty-box">Sheet kosong.</div>`);
          return;
        }

        if (sheetName === 'UKM PANAHAN' && data[0].length === 1) {
          let infoHtml = `<h3 class="page-title">${sheetName}</h3><p class="page-sub">${data.length - 1} baris</p>`;
          infoHtml += '<div class="info-text">';
          for (let i = 0; i < data.length; i++) {
            infoHtml += data[i][0] + '<br>';
          }
          infoHtml += '</div>';
          setContent(infoHtml);
          return;
        }

        const headers = data[0];
        const rows = data.slice(1).filter(r => r.some(c => c !== '' && c !== null && c !== undefined));

        let tHead = headers.map(h => `<th>${h}</th>`).join('');
        let tBody = rows.map(r => '<tr>' + r.map(c => `<td>${c || '-'}</td>`).join('') + '</tr>').join('');

        setContent(`
        <h3 class="page-title">${sheetName}</h3>
        <p class="page-sub">${rows.length} data ditemukan</p>
        <div class="stats" id="summary"></div>
        <div class="table-box">
          <div class="table-top">
            <h3>${sheetName}</h3>
            <input type="text" id="q" placeholder="Cari..." oninput="filterTable()">
          </div>
          <table>
            <thead><tr>${tHead}</tr></thead>
            <tbody id="tbody">${tBody}</tbody>
          </table>
        </div>
      `);

        const single = {};
        single[sheetName] = rows.length;
        renderStats('summary', single);
        fetchSummary().then(s => renderStats('summary', s)).catch(() => { });

      } catch (e) {
        setContent(`
        <h3 class="page-title">${sheetName}</h3>
        <div class="error-box">Gagal memuat sheet "${sheetName}".<br>
        <small>${e.message}</small></div>
      `);
      }
    }

    function loadPage(name) {
      setActive(name);
      if (name === 'Home') showHome();
      else showSheet(name);
    }

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
      document.getElementById('sidebarOverlay').classList.toggle('show');
    }

    function closeSidebar() {
      document.getElementById('sidebar').classList.remove('open');
      document.getElementById('sidebarOverlay').classList.remove('show');
    }

    document.querySelectorAll('.sidebar nav button').forEach(btn => {
      btn.addEventListener('click', () => {
        if (window.innerWidth <= 768) closeSidebar();
      });
    });

    // Load Google Visualization API, then start
    google.charts.load('current');
    google.charts.setOnLoadCallback(() => {
      loadPage('Home');
    });
  </script>

</body>

</html>